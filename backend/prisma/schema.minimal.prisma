// ==============================================
// SPOTLIGHT LOVER - MINIMAL SCHEMA (SQLite)
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==============================================
// MODÈLE ADMIN
// ==============================================
model Admin {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("MODERATOR") // "SUPER_ADMIN" ou "MODERATOR"
  
  // 2FA et sécurité
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?  @map("two_factor_secret")
  isActive         Boolean  @default(true) @map("is_active")
  
  // Métadonnées
  lastLoginAt      DateTime?  @map("last_login_at")
  lastLoginIp      String?    @map("last_login_ip")
  failedLoginAttempts Int     @default(0) @map("failed_login_attempts")
  
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  
  // Relations
  logs             AuditLog[]
  
  @@map("admins")
}

// ==============================================
// MODÈLE CANDIDAT
// ==============================================
model Candidate {
  id            String    @id @default(uuid())
  
  // Informations personnelles
  name          String
  age           Int
  country       String
  city          String
  bio           String
  
  // Vidéo
  videoUrl      String    @map("video_url")
  videoPublicId String?   @map("video_public_id")
  videoDuration Int?      @map("video_duration")
  thumbnailUrl  String?   @map("thumbnail_url")
  
  // Réseaux sociaux
  instagram     String?
  tiktok        String?
  phone         String
  email         String
  
  // Statut
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED, SUSPENDED
  
  // Métadonnées submission
  submittedBy   String?   @map("submitted_by")
  submissionIp  String?   @map("submission_ip")
  userAgent     String?   @map("user_agent")
  
  // Statistiques
  totalVotes    Int       @default(0) @map("total_votes")
  totalRevenue  Float     @default(0) @map("total_revenue")
  viewCount     Int       @default(0) @map("view_count")
  shareCount    Int       @default(0) @map("share_count")
  rank          Int       @default(0)
  
  // Validation
  validatedAt   DateTime? @map("validated_at")
  validatedBy   String?   @map("validated_by")
  rejectionReason String? @map("rejection_reason")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  votes         Vote[]
  
  @@map("candidates")
}

// ==============================================
// MODÈLE VOTE
// ==============================================
model Vote {
  id            String    @id @default(uuid())
  candidateId   String    @map("candidate_id")
  
  // Informations votant
  voterName     String?   @map("voter_name")
  voterEmail    String?   @map("voter_email")
  voterPhone    String    @map("voter_phone")
  voterCountry  String?   @map("voter_country")
  voterIp       String?   @map("voter_ip")
  
  // Paiement
  amount        Float     @default(100) // 100 FCFA par défaut
  currency      String    @default("XOF")
  paymentMethod String    @map("payment_method") // MTN_MOBILE_MONEY, ORANGE_MONEY, CARD
  paymentProvider String? @map("payment_provider")
  paymentStatus String    @default("PENDING") @map("payment_status") // PENDING, COMPLETED, FAILED
  
  // Références paiement
  transactionId String?   @unique @map("transaction_id")
  referenceId   String?   @map("reference_id")
  
  // Anti-fraude
  fraudScore    Float?    @default(0) @map("fraud_score")
  verifiedAt    DateTime? @map("verified_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  @@map("votes")
  @@index([candidateId])
  @@index([paymentStatus])
}

// ==============================================
// MODÈLE AUDIT LOG
// ==============================================
model AuditLog {
  id          String    @id @default(uuid())
  adminId     String    @map("admin_id")
  
  // Action
  action      String    // CREATE, UPDATE, DELETE, APPROVE, REJECT
  entityType  String    @map("entity_type") // CANDIDATE, VOTE, ADMIN, SETTINGS
  entityId    String    @map("entity_id")
  
  // Données (string JSON)
  oldData     String?   @map("old_data")
  newData     String?   @map("new_data")
  details     String?
  
  // Contexte
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // Relations
  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  
  @@map("audit_logs")
  @@index([adminId])
  @@index([action])
}
